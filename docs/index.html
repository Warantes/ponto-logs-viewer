<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registros de Ponto</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #111;
      --header-bg: #f0f0f0;
      --btn-bg: #f5f5f5;
      --btn-border: #ccc;
      --table-border: #ccc;
    }
    [data-theme="dark"] {
      --bg-color: #1a1a1a;
      --text-color: #eee;
      --header-bg: #2a2a2a;
      --btn-bg: #333;
      --btn-border: #555;
      --table-border: #444;
    }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
    }
    .top-bar input,
    .top-bar button {
      padding: 0.5rem;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--text-color);
      border-radius: 5px;
    }
    .top-bar button i {
      margin-right: 6px;
    }
    .resumo {
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--header-bg);
      border-radius: 8px;
      font-weight: bold;
    }
    .resumo span {
      margin-right: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid var(--table-border);
    }
    th {
      background: var(--header-bg);
    }
    .status-sucesso {
      color: green;
      font-weight: bold;
    }
    .status-falha {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>ðŸ“‹ Registros de Ponto</h1>

  <div class="top-bar">
    <button onclick="toggleTheme()"><i class="fa fa-moon"></i> Modo Claro/Escuro</button>
    <input type="text" id="filtroNome" placeholder="ðŸ” Filtrar por nome" />
    <input type="date" id="dataInicio" />
    <input type="date" id="dataFim" />
    <button onclick="filtrarDados()"><i class="fa fa-search"></i> Filtrar</button>
    <button onclick="limparFiltros()"><i class="fa fa-paintbrush"></i> Limpar Filtro</button>
    <button onclick="exportarCSV()"><i class="fa fa-download"></i> CSV</button>
  </div>

  <div class="resumo" id="resumo">Carregando...</div>

  <table id="tabela">
    <thead>
      <tr>
        <th>Data</th>
        <th>Nome</th>
        <th>Entrada</th>
        <th>SaÃ­da</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let dados = [];

    async function carregarJSON() {
      const res = await fetch("logs.json");
      dados = await res.json();
      limparFiltros();
    }

    function agruparRegistros(dadosFiltrados) {
      const agrupado = {};
      dadosFiltrados.forEach(d => {
        const chave = `${d.data}-${d.nome}`;
        if (!agrupado[chave]) agrupado[chave] = { ...d, entrada: null, saida: null };
        if (d.hora < "12:00:00") agrupado[chave].entrada = d.hora;
        else agrupado[chave].saida = d.hora;
        agrupado[chave].status = d.status;
      });
      return Object.values(agrupado);
    }

    function renderizarTabela(dadosFiltrados) {
      const tbody = document.querySelector("#tabela tbody");
      tbody.innerHTML = "";

      const agrupados = agruparRegistros(dadosFiltrados);
      agrupados.forEach(r => {
        const linha = document.createElement("tr");
        linha.innerHTML = `
          <td>${r.data}</td>
          <td>${r.nome}</td>
          <td>${r.entrada || ""}</td>
          <td>${r.saida || ""}</td>
          <td class="${r.status.includes('Sucesso') ? 'status-sucesso' : 'status-falha'}">${r.status}</td>
        `;
        tbody.appendChild(linha);
      });

      const total = agrupados.length;
      const sucessos = agrupados.filter(d => d.status.includes("Sucesso")).length;
      const falhas = agrupados.filter(d => d.status.includes("Falha")).length;
      const percSucesso = total > 0 ? ((sucessos / total) * 100).toFixed(1) : 0;

      document.getElementById("resumo").innerHTML =
        `<span>Total: ${total}</span> <span>Sucessos: ${sucessos}</span> <span>Falhas: ${falhas}</span> <span>% Sucesso: ${percSucesso}%</span>`;
    }

    function filtrarDados() {
      const nome = document.getElementById("filtroNome").value.toLowerCase();
      const de = document.getElementById("dataInicio").value;
      const ate = document.getElementById("dataFim").value;

      const filtrado = dados.filter(d => {
        const nomeMatch = !nome || d.nome.toLowerCase().includes(nome);
        const dataBr = d.data.split("/").reverse().join("-");
        const dataMatch = (!de || dataBr >= de) && (!ate || dataBr <= ate);
        return nomeMatch && dataMatch;
      });

      renderizarTabela(filtrado);
    }

    function limparFiltros() {
      document.getElementById("filtroNome").value = "";
      document.getElementById("dataInicio").value = "";
      document.getElementById("dataFim").value = "";
      renderizarTabela(dados);
    }

    function exportarCSV() {
      let csv = "Data,Nome,Entrada,SaÃ­da,Status\n";
      const linhas = document.querySelectorAll("#tabela tbody tr");
      linhas.forEach(linha => {
        const colunas = linha.querySelectorAll("td");
        const valores = Array.from(colunas).map(td => td.textContent);
        csv += valores.join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "registros.csv";
      link.click();
    }

    function toggleTheme() {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === "dark" ? "light" : "dark";
    }

    carregarJSON();
  </script>
</body>
</html>
